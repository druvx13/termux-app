name: Termux Release APK (auto-sign + publish, fork pkg)

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

jobs:
  build-and-auto-sign:
    runs-on: ubuntu-latest

    env:
      # cache key suffix - bump to force new keystore generation if needed
      KEYSTORE_CACHE_VERSION: 'v1'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '11'
          cache: 'gradle'

      - name: Install Android SDK (cmdline-tools + platform-tools + build-tools)
        uses: r0adkll/setup-android@v2
        with:
          api-level: 33
          build-tools: 33.0.2
          components: platform-tools,cmdline-tools;latest,platforms;android-33

      - name: Accept Android SDK licenses
        run: yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true

      - name: Make gradlew executable
        run: |
          cd termux-app
          chmod +x ./gradlew

      - name: Ensure package id is changed to com.druvx13.termux (build-time)
        working-directory: termux-app
        run: |
          # Replace applicationId and manifest placeholder just for CI build
          sed -i 's/applicationId "com.termux"/applicationId "com.druvx13.termux"/' app/build.gradle || true
          sed -i 's/manifestPlaceholders.TERMUX_PACKAGE_NAME = "com.termux"/manifestPlaceholders.TERMUX_PACKAGE_NAME = "com.druvx13.termux"/' app/build.gradle || true
          # Optional: update other placeholders if desired
          grep -E "applicationId|TERMUX_PACKAGE_NAME" -n app/build.gradle || true

      - name: Restore keystore cache (auto-keystore)
        uses: actions/cache@v4
        with:
          path: .github/ci-keystore
          key: keystore-${{ github.repository }}-${{ env.KEYSTORE_CACHE_VERSION }}

      - name: Generate keystore if missing (auto)
        run: |
          set -euo pipefail
          mkdir -p .github/ci-keystore
          KS_PATH=".github/ci-keystore/release-keystore.jks"
          INFO_PATH=".github/ci-keystore/keystore-info.json"
          if [ ! -f "$KS_PATH" ]; then
            echo "No cached keystore found â€” generating a new keystore..."
            # deterministic passwords are not used; generated values stored alongside keystore
            KEY_ALIAS="release"
            STOREPASS="$(head -c 24 /dev/urandom | base64 | tr -dc 'A-Za-z0-9' | cut -c1-20)"
            KEYPASS="$(head -c 24 /dev/urandom | base64 | tr -dc 'A-Za-z0-9' | cut -c1-20)"
            keytool -genkeypair \
              -alias "$KEY_ALIAS" \
              -keyalg RSA -keysize 2048 -validity 10000 \
              -dname "CN=CI, OU=CI, O=GitHub, L=Internet, ST=None, C=US" \
              -keystore "$KS_PATH" -storepass "$STOREPASS" -keypass "$KEYPASS" -storetype JKS
            jq -n --arg alias "$KEY_ALIAS" --arg sp "$STOREPASS" --arg kp "$KEYPASS" '{"alias":$alias,"storepass":$sp,"keypass":$kp}' > "$INFO_PATH" || \
            echo "{\"alias\":\"$KEY_ALIAS\",\"storepass\":\"$STOREPASS\",\"keypass\":\"$KEYPASS\"}" > "$INFO_PATH"
            echo "Keystore generated and saved to $KS_PATH"
          else
            echo "Using cached keystore at $KS_PATH"
          fi
        shell: bash

      - name: Build release APK(s)
        working-directory: termux-app
        run: |
          ./gradlew --no-daemon clean assembleRelease --stacktrace

      - name: Find latest build-tools path
        run: |
          BT=$(ls "$ANDROID_SDK_ROOT/build-tools" | sort -V | tail -n1)
          echo "BUILD_TOOLS=$BT" >> $GITHUB_ENV

      - name: Align & sign APK(s) with auto-keystore
        working-directory: termux-app
        env:
          ANDROID_HOME: ${{ env.ANDROID_SDK_ROOT }}
        run: |
          set -euo pipefail
          BT="${{ env.BUILD_TOOLS }}"
          if [ -z "$BT" ]; then
            BT=$(ls "$ANDROID_SDK_ROOT/build-tools" | sort -V | tail -n1)
          fi
          ZIPALIGN="$ANDROID_SDK_ROOT/build-tools/$BT/zipalign"
          APKSIGNER="$ANDROID_SDK_ROOT/build-tools/$BT/apksigner"
          KS_DIR="../.github/ci-keystore"
          KS_PATH="$KS_DIR/release-keystore.jks"
          INFO_PATH="$KS_DIR/keystore-info.json"
          if [ ! -f "$KS_PATH" ]; then
            echo "Keystore missing at $KS_PATH"
            exit 1
          fi
          # read keystore info
          ALIAS=$(jq -r '.alias' "$INFO_PATH")
          STOREPASS=$(jq -r '.storepass' "$INFO_PATH")
          KEYPASS=$(jq -r '.keypass' "$INFO_PATH")

          mkdir -p ../signed-apks
          shopt -s nullglob
          APKS=(app/build/outputs/apk/release/*release*.apk)
          if [ "${#APKS[@]}" -eq 0 ]; then
            echo "No release APKs found. Exiting."
            exit 1
          fi

          for apk in "${APKS[@]}"; do
            base=$(basename "$apk")
            aligned="../signed-apks/aligned-$base"
            signed="../signed-apks/signed-$base"
            echo "Zipaligning $apk -> $aligned"
            "$ZIPALIGN" -f -v 4 "$apk" "$aligned"
            echo "Signing $aligned -> $signed"
            "$APKSIGNER" sign \
              --ks "$KS_PATH" \
              --ks-pass "pass:$STOREPASS" \
              --key-pass "pass:$KEYPASS" \
              --ks-key-alias "$ALIAS" \
              --out "$signed" "$aligned"
            echo "Verifying $signed"
            "$APKSIGNER" verify --print-certs "$signed"
          done

          echo "Signed APKs:"
          ls -la ../signed-apks || true

      - name: Upload signed APK artifact
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: signed-apks
          path: termux-app/signed-apks/*.apk

      - name: Create GitHub release and attach APK(s)
        if: github.ref_type == 'tag'
        uses: softprops/action-gh-release@v1
        with:
          files: termux-app/signed-apks/*.apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Persist keystore to cache (no-op if cache already existed)
        uses: actions/cache@v4
        with:
          path: .github/ci-keystore
          key: keystore-${{ github.repository }}-${{ env.KEYSTORE_CACHE_VERSION }}
